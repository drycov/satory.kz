version: "3.9"

# ======================================================================
# COMMON ANCHORS (base templates)
# ======================================================================
x-netbox-base: &netbox-base
  build: .


  restart: unless-stopped
  networks:
    - satory_net
  depends_on:
    - postgres-netbox
    - redis
    - redis-cache
  env_file: env/netbox.env
  volumes:
    - ./configuration:/etc/netbox/config:ro,z
    - netbox-media-files:/opt/netbox/netbox/media:rw
    - netbox-reports-files:/opt/netbox/netbox/reports:rw
    - netbox-scripts-files:/opt/netbox/netbox/scripts:rw
    - ./plugin_requirements.txt:/opt/netbox/plugin_requirements.txt:z

# ======================================================================
# SERVICES
# ======================================================================
services:
  # --------------------------------------------------------------------
  # NETBOX (WEB)
  # --------------------------------------------------------------------
  netbox:
    <<: *netbox-base
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8080/login/ || exit 1"]
      start_period: 90s
      timeout: 3s
      interval: 15s
      retries: 5

  # --------------------------------------------------------------------
  # NETBOX WORKER (RQ)
  # --------------------------------------------------------------------
  netbox-worker:
    <<: *netbox-base
    command:
      - /opt/netbox/venv/bin/python
      - /opt/netbox/netbox/manage.py
      - rqworker
    healthcheck:
      test: ["CMD-SHELL", "ps -aux | grep -v grep | grep -q rqworker || exit 1"]
      start_period: 20s
      timeout: 3s
      interval: 15s
      retries: 5

  # --------------------------------------------------------------------
  # NETBOX HOUSEKEEPING (periodic tasks)
  # --------------------------------------------------------------------
  netbox-housekeeping:
    <<: *netbox-base
    depends_on:
      netbox:
        condition: service_healthy
    command:
      - /opt/netbox/venv/bin/python
      - /opt/netbox/netbox/manage.py
      - housekeeping
    healthcheck:
      test: ["CMD-SHELL", "ps -aux | grep -v grep | grep -q housekeeping || exit 1"]
      start_period: 20s
      interval: 15s
      retries: 5


  # --------------------------------------------------------------------
  # POSTGRESQL 17
  # --------------------------------------------------------------------
  postgres-netbox:
    image: docker.io/postgres:17-alpine
    restart: unless-stopped
    networks:
      - satory_net
    env_file: env/postgres-netbox.env
    volumes:
      - netbox-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -q -t 2 -d \"$POSTGRES_NETBOX_DB\" -U \"$POSTGRES_NETBOX_USER\""]
      start_period: 20s
      timeout: 30s
      interval: 10s
      retries: 5

  # --------------------------------------------------------------------
  # VALKEY (Redis replacement)
  # --------------------------------------------------------------------
  redis:
    image: docker.io/valkey/valkey:8.1-alpine
    restart: unless-stopped
    env_file: env/redis.env
    networks:
      - satory_net
    command:
      - sh
      - -c
      - valkey-server --appendonly yes --requirepass $$REDIS_PASSWORD
    volumes:
      - netbox-redis-data:/data
    healthcheck: &redis-healthcheck
      test: '[ $$(valkey-cli --pass "$${REDIS_PASSWORD}" ping) = "PONG" ]'
      start_period: 5s
      timeout: 3s
      interval: 1s
      retries: 5

  redis-cache:
    image: docker.io/valkey/valkey:8.1-alpine
    restart: unless-stopped
    env_file: env/redis-cache.env
    networks:
      - satory_net
    command:
      - sh
      - -c
      - valkey-server --requirepass $$REDIS_PASSWORD
    volumes:
      - netbox-redis-cache-data:/data
    healthcheck: *redis-healthcheck

  # --------------------------------------------------------------------
  # OXIDIZED (Network Config Backup)
  # --------------------------------------------------------------------
  oxidized:
    image: oxidized/oxidized:latest
    restart: unless-stopped
    networks:
      - satory_net
    volumes:
      - ./oxidized/config:/home/oxidized/.config/oxidized
      - ./oxidized/backups:/home/oxidized/.config/oxidized/backups
    ports:
      - "8888:8888"
    environment:
      CONFIG_RELOAD: "300"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8888 || exit 1"]
      interval: 30s
      timeout: 3s
      retries: 5

# ======================================================================
# VOLUMES
# ======================================================================
volumes:
  netbox-media-files:
  netbox-postgres-data:
  netbox-redis-cache-data:
  netbox-redis-data:
  netbox-reports-files:
  netbox-scripts-files:

# ======================================================================
# NETWORKS
# ======================================================================
networks:
  satory_net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: satory0