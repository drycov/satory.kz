version: "3.9"

# ======================================================================
# COMMON ANCHORS (base templates)
# ======================================================================
x-netbox-base: &netbox-base
  build: .
  restart: unless-stopped
  networks:
    - satory_net
    - back-tier
  depends_on:
    postgres-netbox:
      condition: service_healthy
    redis:
      condition: service_healthy
    redis-cache:
      condition: service_healthy
  env_file: env/netbox.env
  volumes:
    - ./configuration:/etc/netbox/config:ro,z
    - netbox-media-files:/opt/netbox/netbox/media:rw
    - netbox-reports-files:/opt/netbox/netbox/reports:rw
    - netbox-scripts-files:/opt/netbox/netbox/scripts:rw
    - ./plugin_requirements.txt:/opt/netbox/plugin_requirements.txt:z

# ======================================================================
# SERVICES
# ======================================================================
services:

  # --------------------------------------------------------------------
  # NETBOX (WEB)
  # --------------------------------------------------------------------
  netbox:
    <<: *netbox-base
    ports:
      - "8080:8080"
    depends_on:
      postgres-netbox:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8080/login/ > /dev/null || exit 1"]
      start_period: 90s
      timeout: 4s
      interval: 15s
      retries: 5

  # --------------------------------------------------------------------
  # NETBOX WORKER (RQ)
  # --------------------------------------------------------------------
  netbox-worker:
    <<: *netbox-base
    depends_on:
      postgres-netbox:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    command: >
      /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep -q rqworker || exit 1"]
      start_period: 15s
      interval: 10s
      timeout: 3s
      retries: 5

  # --------------------------------------------------------------------
  # NETBOX HOUSEKEEPING (periodic cleanup jobs)
  # --------------------------------------------------------------------
  netbox-housekeeping:
    <<: *netbox-base
    depends_on:
      postgres-netbox:
        condition: service_healthy
      redis:
        condition: service_healthy
      redis-cache:
        condition: service_healthy
    command: >
      /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py housekeeping
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep -q housekeeping || exit 1"]
      start_period: 15s
      interval: 10s
      retries: 5

  # --------------------------------------------------------------------
  # POSTGRESQL 17
  # --------------------------------------------------------------------
  postgres-netbox:
    image: postgres:17-alpine
    restart: unless-stopped
    env_file: env/postgres-netbox.env
    container_name: netbox-postgres
    networks:
      - back-tier
    volumes:
      - netbox-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -q -t 2 -d \"$${POSTGRES_DB}\" -U \"$${POSTGRES_USER}\""]
      start_period: 20s
      timeout: 5s
      interval: 10s
      retries: 5

  # --------------------------------------------------------------------
  # REDIS (Valkey primary)
  # --------------------------------------------------------------------
  redis:
    image: valkey/valkey:8.1-alpine
    restart: unless-stopped
    env_file: env/redis.env
    command: >
      sh -c 'valkey-server --appendonly yes --requirepass "$$REDIS_PASSWORD"'
    networks:
      - back-tier
    volumes:
      - netbox-redis-data:/data
    healthcheck:
      test: ['CMD-SHELL', '[ "$(valkey-cli --pass "$${REDIS_PASSWORD}" ping)" = "PONG" ]']
      start_period: 5s
      interval: 2s
      retries: 5

  # --------------------------------------------------------------------
  # REDIS CACHE (Valkey)
  # --------------------------------------------------------------------
  redis-cache:
    image: valkey/valkey:8.1-alpine
    restart: unless-stopped
    env_file: env/redis-cache.env
    command: >
      sh -c 'valkey-server --requirepass "$$REDIS_PASSWORD"'
    networks:
      - back-tier
    volumes:
      - netbox-redis-cache-data:/data
    healthcheck:
      test: ['CMD-SHELL', '[ "$(valkey-cli --pass "$${REDIS_PASSWORD}" ping)" = "PONG" ]']
      start_period: 5s
      interval: 2s
      retries: 5

  # --------------------------------------------------------------------
  # OXIDIZED
  # --------------------------------------------------------------------
  oxidized:
    image: oxidized/oxidized:latest
    restart: unless-stopped
    networks:
      - satory_net
    ports:
      - "8888:8888"
    volumes:
      - ./oxidized/config:/home/oxidized/.config/oxidized
      - ./oxidized/backups:/home/oxidized/.config/oxidized/backups
    environment:
      CONFIG_RELOAD: "300"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8888 || exit 1"]
      interval: 20s
      retries: 5

  # --------------------------------------------------------------------
  # MARIADB FOR OBSERVIUM
  # --------------------------------------------------------------------
  observium-db:
    image: mariadb:11
    restart: unless-stopped
    env_file: env/mariadb.env
    networks:
      - back-tier
    volumes:
      - observium-mariadb-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u \"${MYSQL_USER}\" --password=\"${MYSQL_PASSWORD}\" --silent"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 25s

  # --------------------------------------------------------------------
  # OBSERVIUM
  # --------------------------------------------------------------------
  observium:
    image: pvrmza/docker-observium:latest
    restart: always
    env_file: env/observium.env
    networks:
      - back-tier
      - satory_net
    ports:
      - "8081:80"
    volumes:
      - ./logs:/opt/observium/logs
      - ./rrd:/opt/observium/rrd
    depends_on:
      observium-db:
        condition: service_healthy

  # --------------------------------------------------------------------
  # OPENLDAP AND PHPLDAPADMIN
  # --------------------------------------------------------------------
  openldap:
    image: osixia/openldap:latest
    container_name: openldap
    restart: unless-stopped
    environment:
      LDAP_ORGANISATION: "Satory Networks"
      LDAP_DOMAIN: "satory.kz"
      LDAP_ADMIN_PASSWORD: "admin"
      LDAP_CONFIG_PASSWORD: "config"
    ports:
      - "389:389"
      - "636:636"
    volumes:
      - ./ldap/data:/var/lib/ldap
      - ./ldap/config:/etc/ldap/slapd.d
    networks:
      - satory_net
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=satory,dc=kz"]
      interval: 30s
      timeout: 10s
      retries: 5

# --------------------------------------------------------------------
# PHPLDAPADMIN
# --------------------------------------------------------------------
  phpldapadmin:
    image: phpldapadmin/phpldapadmin:latest
    container_name: phpldapadmin
    restart: unless-stopped
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: openldap
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "8082:8080"
    networks:
      - satory_net
    depends_on:
      - openldap

# --------------------------------------------------------------------
# VAULT
# --------------------------------------------------------------------
  vault:
    image: hashicorp/vault:1.17
    container_name: vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_LOCAL_CONFIG: |
        {
          "backend": {
            "file": {
              "path": "/vault/file"
            }
          },
          "listener": {
            "tcp": {
              "address": "0.0.0.0:8200",
              "tls_disable": 1
            }
          },
          "ui": true
        }
    ports:
      - "8200:8200"
    volumes:
      - vault-data:/vault/file
    networks:
      - satory_net



# ======================================================================
# VOLUMES
# ======================================================================
volumes:
  netbox-media-files:
  netbox-postgres-data:
  netbox-redis-data:
  netbox-redis-cache-data:
  netbox-reports-files:
  netbox-scripts-files:
  keycloak-postgres-data:
  vault-data:
  observium-mariadb-data:
    driver: local
    driver_opts:
      type: none
      device: /opt/satory.kz/data/observium-mariadb
      o: bind
# ======================================================================
# NETWORKS
# ======================================================================
networks:
  satory_net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: satory0

  back-tier:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: backend0
