version: "3.9"

# ============================================================
# NETWORKS
# ============================================================
networks:
  satory_net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: satory0

  back-tier:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: backend0

# ============================================================
# VOLUMES
# ============================================================
volumes:
  # NETBOX
  netbox-media-files:
  netbox-postgres-data:
  netbox-redis-data:
  netbox-redis-cache-data:
  netbox-reports-files:
  netbox-scripts-files:

  # OBSERVIUM
  observium-mariadb-data:

  # OXIDIZED
  oxidized-config:
  oxidized-repo:

# ============================================================
# SHARED CONFIG
# ============================================================

x-netbox-base: &netbox-base
  build: ./netbox
  restart: unless-stopped
  networks:
    - satory_net
  depends_on:
    postgres-netbox:
      condition: service_healthy
    redis:
      condition: service_healthy
    redis-cache:
      condition: service_healthy
  env_file: env/netbox.env
  volumes:
    - ./netbox/configuration:/etc/netbox/config:ro,z
    - netbox-media-files:/opt/netbox/netbox/media:rw
    - netbox-reports-files:/opt/netbox/netbox/reports:rw
    - netbox-scripts-files:/opt/netbox/netbox/scripts:rw
    - ./netbox/plugin_requirements.txt:/opt/netbox/plugin_requirements.txt:z

# ============================================================
# SERVICES
# ============================================================
services:

  # ------------------------------------------------------------
  # NETBOX (WEB)
  # ------------------------------------------------------------
  netbox:
    <<: *netbox-base
    ports:
      - "9000:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8080/login/ > /dev/null || exit 1"]
      start_period: 90s
      interval: 15s
      timeout: 4s
      retries: 5

  # ------------------------------------------------------------
  # NETBOX WORKER (RQ)
  # ------------------------------------------------------------
  netbox-worker:
    <<: *netbox-base
    command: >
      /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep -q rqworker || exit 1"]
      start_period: 15s
      interval: 10s
      timeout: 3s
      retries: 5

  # ------------------------------------------------------------
  # NETBOX HOUSEKEEPING
  # ------------------------------------------------------------
  netbox-housekeeping:
    <<: *netbox-base
    depends_on:
      netbox:
        condition: service_healthy
    command: >
      /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py housekeeping
    restart: "no"
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep -q housekeeping || exit 1"]
      start_period: 15s
      interval: 10s
      retries: 5

  # ------------------------------------------------------------
  # POSTGRESQL 17
  # ------------------------------------------------------------
  postgres-netbox:
    image: postgres:17
    restart: unless-stopped
    env_file: env/postgres-netbox.env
    networks:
      - satory_net
    volumes:
      - netbox-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -q -t 2 -d \"$POSTGRES_DB\" -U \"$POSTGRES_USER\""]
      start_period: 25s
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------------------------------------------
  # REDIS (VALKEY PRIMARY)
  # ------------------------------------------------------------
  redis:
    image: valkey/valkey:8.1-alpine
    restart: unless-stopped
    env_file: env/redis.env
    command: >
      sh -c 'valkey-server --appendonly yes --appendfsync everysec --requirepass "$$REDIS_PASSWORD"'
    networks:
      - satory_net
    volumes:
      - netbox-redis-data:/data
    healthcheck:
      test: ['CMD-SHELL', '[ "$(valkey-cli -a "$${REDIS_PASSWORD}" ping)" = "PONG" ]']
      interval: 2s
      retries: 5

  # ------------------------------------------------------------
  # REDIS CACHE (VALKEY)
  # ------------------------------------------------------------
  redis-cache:
    image: valkey/valkey:8.1-alpine
    restart: unless-stopped
    env_file: env/redis-cache.env
    command: >
      sh -c 'valkey-server --requirepass "$$REDIS_PASSWORD"'
    networks:
      - satory_net
    volumes:
      - netbox-redis-cache-data:/data
    healthcheck:
      test: ['CMD-SHELL', '[ "$(valkey-cli -a "$${REDIS_PASSWORD}" ping)" = "PONG" ]']
      interval: 2s
      retries: 5

  # ============================================================
  # OXIDIZED (CONFIG BACKUPS)
  # ============================================================

  oxidized:
    image: oxidized/oxidized:latest
    container_name: oxidized
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "8888:8888"
    networks:
      - back-tier
    environment:
      CONFIG_RELOAD_INTERVAL: 3600
    volumes:
      - oxidized-config:/etc/oxidized
      - oxidized-repo:/root/.config/oxidized
      - ./oxidized/config:/etc/oxidized:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8888/nodes.json > /dev/null || exit 1"]
      interval: 20s
      retries: 3

  # ============================================================
  # MARIADB FOR OBSERVIUM
  # ============================================================

  observium-db:
    image: mariadb:11
    restart: unless-stopped
    env_file: env/mariadb.env
    networks:
      - back-tier
    volumes:
      - observium-mariadb-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost --silent"]
      interval: 10s
      retries: 5

  # ============================================================
  # OBSERVIUM
  # ============================================================

  observium:
    image: pvrmza/docker-observium:latest
    restart: always
    env_file: env/observium.env
    networks:
      - back-tier
    ports:
      - "8081:80"
    depends_on:
      observium-db:
        condition: service_healthy
      oxidized:
        condition: service_started
    volumes:
      - ./observium/logs:/opt/observium/logs
      - ./observium/rrd:/opt/observium/rrd
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost > /dev/null || exit 1"]
      interval: 20s
      retries: 3
