version: "3.9"

# ===============================================================
# ANCHORS
# ===============================================================
x-netbox-base: &netbox-base
  build: .
  restart: unless-stopped
  networks: [ front-tier, back-tier ]
  depends_on:
    postgres-netbox: { condition: service_healthy }
    redis: { condition: service_healthy }
    redis-cache: { condition: service_healthy }
  env_file: env/netbox.env
  volumes:
    - ./configuration:/etc/netbox/config:ro,z
    - netbox-media:/opt/netbox/netbox/media:rw
    - netbox-reports:/opt/netbox/netbox/reports:rw
    - netbox-scripts:/opt/netbox/netbox/scripts:rw
    - ./plugin_requirements.txt:/opt/netbox/plugin_requirements.txt:z

# ===============================================================
# SERVICES
# ===============================================================
services:

  # ---------------- NetBox (Web UI) ----------------
  netbox:
    <<: *netbox-base
    container_name: netbox
    ports:
      - "8080:8080"
    healthcheck:
      test: [ "CMD-SHELL", "curl -fs http://localhost:8080/login/ > /dev/null || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

  # ---------------- NetBox Worker ----------------
  netbox-worker:
    <<: *netbox-base
    container_name: netbox-worker
    command: >
      /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py rqworker
    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f rqworker || exit 1" ]
      interval: 10s
      retries: 5

  # ---------------- Housekeeping ----------------
  netbox-housekeeping:
    <<: *netbox-base
    container_name: netbox-housekeeping
    depends_on:
      netbox: { condition: service_healthy }
    command: >
      /opt/netbox/venv/bin/python /opt/netbox/netbox/manage.py housekeeping

    healthcheck:
      test: [ "CMD-SHELL", "pgrep -f housekeeping || exit 1" ]
      interval: 10s
      retries: 5

  # ---------------- PostgreSQL 17 ----------------
  postgres-netbox:
    image: postgres:17-alpine
    container_name: postgres-netbox
    restart: unless-stopped
    env_file: env/postgres-netbox.env
    networks: [ back-tier ]
    volumes:
      - netbox-postgres:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -q -d \"$POSTGRES_DB\" -U \"$POSTGRES_USER\"" ]
      interval: 10s
      timeout: 4s
      retries: 5

  # ---------------- Redis (Primary) ----------------
  redis:
    image: valkey/valkey:8.1-alpine
    container_name: redis-netbox
    restart: unless-stopped
    env_file: env/redis.env
    networks: [ back-tier ]
    command: >
      sh -c 'valkey-server --appendonly yes --requirepass "$$REDIS_PASSWORD"'
    volumes:
      - netbox-redis:/data
    healthcheck:
      test: [ 'CMD-SHELL', '[ "$(valkey-cli --pass "$${REDIS_PASSWORD}" ping)" = "PONG" ]' ]
      interval: 2s
      retries: 5

  # ---------------- Redis Cache ----------------
  redis-cache:
    image: valkey/valkey:8.1-alpine
    container_name: redis-cache-netbox
    restart: unless-stopped
    env_file: env/redis-cache.env
    networks: [ back-tier ]
    command: >
      sh -c 'valkey-server --requirepass "$$REDIS_PASSWORD"'
    volumes:
      - netbox-redis-cache:/data
    healthcheck:
      test: [ 'CMD-SHELL', '[ "$(valkey-cli --pass "$${REDIS_PASSWORD}" ping)" = "PONG" ]' ]
      interval: 2s
      retries: 5

  # ---------------- Oxidized ----------------
  oxidized:
    image: oxidized/oxidized:latest
    container_name: oxidized
    restart: unless-stopped
    networks: [ front-tier ]
    ports:
      - "8888:8888"
    volumes:
      - ./oxidized/config:/home/oxidized/.config/oxidized
      - ./oxidized/backups:/home/oxidized/.config/oxidized/backups
    environment:
      CONFIG_RELOAD: "300"
    healthcheck:
      test: [ "CMD-SHELL", "curl -fs http://localhost:8888 || exit 1" ]
      interval: 15s
      retries: 5

  # ===============================================================
  # LIBRENMS STACK
  # ===============================================================

  db:
    image: mariadb:latest
    container_name: librenms_db
    restart: always
    command:
      - "mysqld"
      - "--innodb-file-per-table=1"
      - "--lower-case-table-names=0"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
    volumes:
      - ./db:/var/lib/mysql
    env_file: env/mariadb.env

  msmtpd:
    image: crazymax/msmtpd:latest
    container_name: librenms-msmtpd
    restart: always
    env_file:
      - ./env/msmtpd.env

  librenms:
    image: librenms/librenms:latest
    container_name: librenms
    hostname: librenms
    restart: always
    networks: [ front-tier ]
    cap_add: [ NET_ADMIN, NET_RAW ]
    ports:
      - target: 8000
        published: 8000
        protocol: tcp
    depends_on:
      - db
      - redis
      - msmtpd
    volumes:
      - ./librenms:/data
    env_file:
      - ./env/librenms.env
    environment:
      - "TZ=${TZ}"
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "DB_HOST=db"

  dispatcher:
    image: librenms/librenms:latest
    container_name: librenms-dispatcher
    hostname: librenms-dispatcher
    restart: always
    depends_on:
      - librenms
      - redis
    volumes:
      - ./librenms:/data
    env_file:
      - ./env/librenms.env
    environment:
      - "TZ=${TZ}"
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "DB_TIMEOUT=60"
      - "DISPATCHER_NODE_ID=dispatcher1"
      - "SIDECAR_DISPATCHER=1"

  syslogng:
    image: librenms/librenms:latest
    container_name: librenms-syslogng
    hostname: librenms-syslogng
    restart: always
    cap_add: [ NET_ADMIN, NET_RAW ]
    depends_on:
      - librenms
      - redis
    ports:
      - "514:514/tcp"
      - "514:514/udp"
    volumes:
      - ./librenms:/data
    env_file:
      - ./env/librenms.env
    environment:
      - "TZ=${TZ}"
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      - "DB_TIMEOUT=60"
      - "SIDECAR_SYSLOGNG=1"

  snmptrapd:
    image: librenms/librenms:latest
    container_name: librenms-snmptrapd
    hostname: librenms-snmptrapd
    restart: always
    cap_add: [ NET_ADMIN, NET_RAW ]
    depends_on:
      - librenms
      - redis
    ports:
      - "162:162/tcp"
      - "162:162/udp"
    volumes:
      - ./librenms:/data
    env_file:
      - ./env/librenms.env
    environment:
      - "DB_TIMEOUT=60"
      - "SIDECAR_SNMPTRAPD=1"
      - "TZ=${TZ}"
      - "PUID=${PUID}"
      - "PGID=${PGID}"
# ===============================================================
# VOLUMES
# ===============================================================
volumes:
  netbox-media:
  netbox-postgres:
  netbox-redis:
  netbox-redis-cache:
  netbox-reports:
  netbox-scripts:

    # ===============================================================
    # NETWORKS
    # ===============================================================
networks:
  front-tier:
    name: satory_net
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: satory0

  back-tier:
    name: backend0
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: backend0
