#!/bin/bash
set -e

SITE_USER=${SITE_USER:-www-data}
PHP_APP_DIR=/app
CONFIG_FILE=/app/config/config.php

echo "* init-docker: starting phpLDAPadmin container"

# -------------------------------------------------------------------
# 1. Генерация конфигурации из переменных окружения
# -------------------------------------------------------------------
if [ -x /sbin/configure-env.php ]; then
    echo "* Generating runtime phpLDAPadmin config..."
    php /sbin/configure-env.php
fi

# -------------------------------------------------------------------
# 2. Права доступа
# -------------------------------------------------------------------
echo "* Fixing permissions..."
chown -R ${SITE_USER}:www-data ${PHP_APP_DIR}
find ${PHP_APP_DIR} -type d -exec chmod 755 {} \;
find ${PHP_APP_DIR} -type f -exec chmod 644 {} \;

# -------------------------------------------------------------------
# 3. Если контейнер запускается root — понижаем привилегии
# -------------------------------------------------------------------
if [ "$(id -u)" = "0" ]; then
    exec su ${SITE_USER} -s /bin/sh -c "/usr/local/bin/frankenphp run $*"
else
    exec /usr/local/bin/frankenphp run "$@"
fi
